<h1>deputy</h1>
<pre><code class="lang-js"><span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>);
<span class="keyword">var</span> existsSync = fs.existsSync || path.existsSync;

<span class="keyword">var</span> mkdirp = require(<span class="string">'mkdirp'</span>);
<span class="keyword">var</span> detective = require(<span class="string">'detective'</span>);

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(cacheFile)</span> {</span>
    mkdirp.sync(path.dirname(cacheFile), <span class="number">0700</span>);
    
    <span class="keyword">var</span> cache = {};
    <span class="keyword">if</span> (existsSync(cacheFile)) {
        <span class="keyword">var</span> body = fs.readFileSync(cacheFile);
        <span class="keyword">try</span> {
            cache = JSON.parse(body);
        }
        <span class="keyword">catch</span> (err) {}
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">save</span> <span class="params">(h, res)</span> {</span>
        cache[h] = res;
        fs.writeFileSync(cacheFile, JSON.stringify(cache));
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">hash</span> <span class="params">(src)</span> {</span>
        <span class="keyword">return</span> <span class="keyword">new</span> crypto.Hash(<span class="string">'md5'</span>).update(src).digest(<span class="string">'hex'</span>);
    }
    
    <span class="keyword">var</span> deputy = <span class="function"><span class="keyword">function</span> <span class="params">(src)</span> {</span>
        <span class="keyword">return</span> deputy.find(src).strings;
    };
    
    deputy.find = <span class="function"><span class="keyword">function</span> <span class="params">(src)</span> {</span>
        <span class="keyword">var</span> h = hash(src);
        <span class="keyword">var</span> c = cache[h];
        <span class="keyword">if</span> (c) <span class="keyword">return</span> c;
        <span class="keyword">else</span> {
            c = detective.find(src);
            save(h, c);
            <span class="keyword">return</span> c;
        }
    };
    
    <span class="keyword">return</span> deputy;
};
</code></pre>