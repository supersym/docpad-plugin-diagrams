<h1>scope.js</h1>
<pre><code class="lang-js"><span class="comment">// Generated by CoffeeScript 1.4.0</span>
(<span class="keyword">function</span>() {
  <span class="keyword">var</span> Scope, extend, last, _ref;

  _ref = require(<span class="string">'./helpers'</span>), extend = _ref.extend, last = _ref.last;

  exports.Scope = Scope = (<span class="keyword">function</span>() {

    Scope.root = <span class="literal">null</span>;

    <span class="function"><span class="keyword">function</span> <span class="title">Scope</span><span class="params">(parent, expressions, method)</span> {</span>
      <span class="keyword">this</span>.parent = parent;
      <span class="keyword">this</span>.expressions = expressions;
      <span class="keyword">this</span>.method = method;
      <span class="keyword">this</span>.variables = [
        {
          name: <span class="string">'arguments'</span>,
          type: <span class="string">'arguments'</span>
        }
      ];
      <span class="keyword">this</span>.positions = {};
      <span class="keyword">if</span> (!<span class="keyword">this</span>.parent) {
        Scope.root = <span class="keyword">this</span>;
      }
    }

    Scope.prototype.add = <span class="keyword">function</span>(name, type, immediate) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.shared &amp;&amp; !immediate) {
        <span class="keyword">return</span> <span class="keyword">this</span>.parent.add(name, type, immediate);
      }
      <span class="keyword">if</span> (Object.prototype.hasOwnProperty.call(<span class="keyword">this</span>.positions, name)) {
        <span class="keyword">return</span> <span class="keyword">this</span>.variables[<span class="keyword">this</span>.positions[name]].type = type;
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="keyword">this</span>.positions[name] = <span class="keyword">this</span>.variables.push({
          name: name,
          type: type
        }) - <span class="number">1</span>;
      }
    };

    Scope.prototype.namedMethod = <span class="keyword">function</span>() {
      <span class="keyword">if</span> (<span class="keyword">this</span>.method.name || !<span class="keyword">this</span>.parent) {
        <span class="keyword">return</span> <span class="keyword">this</span>.method;
      }
      <span class="keyword">return</span> <span class="keyword">this</span>.parent.namedMethod();
    };

    Scope.prototype.find = <span class="keyword">function</span>(name) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.check(name)) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      <span class="keyword">this</span>.add(name, <span class="string">'var'</span>);
      <span class="keyword">return</span> <span class="literal">false</span>;
    };

    Scope.prototype.parameter = <span class="keyword">function</span>(name) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.shared &amp;&amp; <span class="keyword">this</span>.parent.check(name, <span class="literal">true</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">return</span> <span class="keyword">this</span>.add(name, <span class="string">'param'</span>);
    };

    Scope.prototype.check = <span class="keyword">function</span>(name) {
      <span class="keyword">var</span> _ref1;
      <span class="keyword">return</span> !!(<span class="keyword">this</span>.type(name) || ((_ref1 = <span class="keyword">this</span>.parent) != <span class="literal">null</span> ? _ref1.check(name) : <span class="keyword">void</span> <span class="number">0</span>));
    };

    Scope.prototype.temporary = <span class="keyword">function</span>(name, index) {
      <span class="keyword">if</span> (name.length > <span class="number">1</span>) {
        <span class="keyword">return</span> <span class="string">'_'</span> + name + (index > <span class="number">1</span> ? index - <span class="number">1</span> : <span class="string">''</span>);
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="string">'_'</span> + (index + parseInt(name, <span class="number">36</span>)).toString(<span class="number">36</span>).replace(<span class="regexp">/\d/g</span>, <span class="string">'a'</span>);
      }
    };

    Scope.prototype.type = <span class="keyword">function</span>(name) {
      <span class="keyword">var</span> v, _i, _len, _ref1;
      _ref1 = <span class="keyword">this</span>.variables;
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
        v = _ref1[_i];
        <span class="keyword">if</span> (v.name === name) {
          <span class="keyword">return</span> v.type;
        }
      }
      <span class="keyword">return</span> <span class="literal">null</span>;
    };

    Scope.prototype.freeVariable = <span class="keyword">function</span>(name, reserve) {
      <span class="keyword">var</span> index, temp;
      <span class="keyword">if</span> (reserve == <span class="literal">null</span>) {
        reserve = <span class="literal">true</span>;
      }
      index = <span class="number">0</span>;
      <span class="keyword">while</span> (<span class="keyword">this</span>.check((temp = <span class="keyword">this</span>.temporary(name, index)))) {
        index++;
      }
      <span class="keyword">if</span> (reserve) {
        <span class="keyword">this</span>.add(temp, <span class="string">'var'</span>, <span class="literal">true</span>);
      }
      <span class="keyword">return</span> temp;
    };

    Scope.prototype.assign = <span class="keyword">function</span>(name, value) {
      <span class="keyword">this</span>.add(name, {
        value: value,
        assigned: <span class="literal">true</span>
      }, <span class="literal">true</span>);
      <span class="keyword">return</span> <span class="keyword">this</span>.hasAssignments = <span class="literal">true</span>;
    };

    Scope.prototype.hasDeclarations = <span class="keyword">function</span>() {
      <span class="keyword">return</span> !!<span class="keyword">this</span>.declaredVariables().length;
    };

    Scope.prototype.declaredVariables = <span class="keyword">function</span>() {
      <span class="keyword">var</span> realVars, tempVars, v, _i, _len, _ref1;
      realVars = [];
      tempVars = [];
      _ref1 = <span class="keyword">this</span>.variables;
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
        v = _ref1[_i];
        <span class="keyword">if</span> (v.type === <span class="string">'var'</span>) {
          (v.name.charAt(<span class="number">0</span>) === <span class="string">'_'</span> ? tempVars : realVars).push(v.name);
        }
      }
      <span class="keyword">return</span> realVars.sort().concat(tempVars.sort());
    };

    Scope.prototype.assignedVariables = <span class="keyword">function</span>() {
      <span class="keyword">var</span> v, _i, _len, _ref1, _results;
      _ref1 = <span class="keyword">this</span>.variables;
      _results = [];
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
        v = _ref1[_i];
        <span class="keyword">if</span> (v.type.assigned) {
          _results.push(<span class="string">""</span> + v.name + <span class="string">" = "</span> + v.type.value);
        }
      }
      <span class="keyword">return</span> _results;
    };

    <span class="keyword">return</span> Scope;

  })();

}).call(<span class="keyword">this</span>);
</code></pre>