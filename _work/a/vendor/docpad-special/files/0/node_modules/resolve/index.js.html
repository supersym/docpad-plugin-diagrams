<h1>resolve</h1>
<pre><code class="lang-js"><span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> existsSync = fs.existsSync || path.existsSync;

<span class="comment">// taken from `ls -1 lib` in node 0.6.11</span>
<span class="keyword">var</span> core = exports.core = [
    <span class="string">'assert'</span>, <span class="string">'buffer_ieee754'</span>, <span class="string">'buffer'</span>, <span class="string">'child_process'</span>, <span class="string">'cluster'</span>, <span class="string">'console'</span>,
    <span class="string">'constants'</span>, <span class="string">'crypto'</span>, <span class="string">'_debugger'</span>, <span class="string">'dgram'</span>, <span class="string">'dns'</span>, <span class="string">'events'</span>, <span class="string">'freelist'</span>,
    <span class="string">'fs'</span>, <span class="string">'http'</span>, <span class="string">'https'</span>, <span class="string">'_linklist'</span>, <span class="string">'module'</span>, <span class="string">'net'</span>, <span class="string">'os'</span>, <span class="string">'path'</span>,
    <span class="string">'punycode'</span>, <span class="string">'querystring'</span>, <span class="string">'readline'</span>, <span class="string">'repl'</span>, <span class="string">'stream'</span>, <span class="string">'string_decoder'</span>,
    <span class="string">'sys'</span>, <span class="string">'timers'</span>, <span class="string">'tls'</span>, <span class="string">'tty'</span>, <span class="string">'url'</span>, <span class="string">'util'</span>, <span class="string">'vm'</span>, <span class="string">'zlib'</span>
].reduce(<span class="function"><span class="keyword">function</span> <span class="params">(acc, x)</span> {</span> acc[x] = <span class="literal">true</span>; <span class="keyword">return</span> acc }, {});

exports.isCore = <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span> <span class="keyword">return</span> core[x] };

exports.sync = <span class="function"><span class="keyword">function</span> <span class="params">(x, opts)</span> {</span>
    <span class="keyword">if</span> (core[x]) <span class="keyword">return</span> x;
    
    <span class="keyword">if</span> (!opts) opts = {};
    <span class="keyword">var</span> isFile = opts.isFile || <span class="function"><span class="keyword">function</span> <span class="params">(file)</span> {</span>
        <span class="keyword">return</span> existsSync(file) &amp;&amp; fs.statSync(file).isFile()
    };
    <span class="keyword">var</span> readFileSync = opts.readFileSync || fs.readFileSync;
    
    <span class="keyword">var</span> extensions = opts.extensions || [ <span class="string">'.js'</span> ];
    <span class="keyword">var</span> y = opts.basedir
        || path.dirname(require.cache[__filename].parent.filename)
    ;

    opts.paths = opts.paths || [];

    <span class="keyword">if</span> (x.match(<span class="regexp">/^(?:\.\.?\/|\/|([A-Za-z]:)?\\)/</span>)) {
        <span class="keyword">var</span> m = loadAsFileSync(path.resolve(y, x))
            || loadAsDirectorySync(path.resolve(y, x));
        <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
    }
    
    <span class="keyword">var</span> n = loadNodeModulesSync(x, y);
    <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
    
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Cannot find module '"</span> + x + <span class="string">"'"</span>);
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsFileSync</span> <span class="params">(x)</span> {</span>
        <span class="keyword">if</span> (isFile(x)) {
            <span class="keyword">return</span> x;
        }
        
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; extensions.length; i++) {
            <span class="keyword">var</span> file = x + extensions[i];
            <span class="keyword">if</span> (isFile(file)) {
                <span class="keyword">return</span> file;
            }
        }
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsDirectorySync</span> <span class="params">(x)</span> {</span>
        <span class="keyword">var</span> pkgfile = path.join(x, <span class="string">'/package.json'</span>);
        <span class="keyword">if</span> (isFile(pkgfile)) {
            <span class="keyword">var</span> body = readFileSync(pkgfile, <span class="string">'utf8'</span>);
            <span class="keyword">try</span> {
                <span class="keyword">var</span> pkg = JSON.parse(body);
                <span class="keyword">if</span> (opts.packageFilter) {
                    pkg = opts.packageFilter(pkg);
                }
                
                <span class="keyword">if</span> (pkg.main) {
                    <span class="keyword">var</span> m = loadAsFileSync(path.resolve(x, pkg.main));
                    <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
                }
            }
            <span class="keyword">catch</span> (err) {}
        }
        
        <span class="keyword">return</span> loadAsFileSync(path.join( x, <span class="string">'/index'</span>));
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadNodeModulesSync</span> <span class="params">(x, start)</span> {</span>
        <span class="keyword">var</span> dirs = nodeModulesPathsSync(start);
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dirs.length; i++) {
            <span class="keyword">var</span> dir = dirs[i];
            <span class="keyword">var</span> m = loadAsFileSync(path.join( dir, <span class="string">'/'</span>, x));
            <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
            <span class="keyword">var</span> n = loadAsDirectorySync(path.join( dir, <span class="string">'/'</span>, x ));
            <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
        }
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">nodeModulesPathsSync</span> <span class="params">(start)</span> {</span>
        <span class="keyword">var</span> splitRe = process.platform === <span class="string">'win32'</span> ? <span class="regexp">/[\/\\]/</span> : <span class="regexp">/\/+/</span>;
        <span class="keyword">var</span> parts = start.split(splitRe);
        
        <span class="keyword">var</span> dirs = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = parts.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
            <span class="keyword">if</span> (parts[i] === <span class="string">'node_modules'</span>) <span class="keyword">continue</span>;
            <span class="keyword">var</span> dir = path.join(
                path.join.apply(path, parts.slice(<span class="number">0</span>, i + <span class="number">1</span>)),
                <span class="string">'node_modules'</span>
            );
            <span class="keyword">if</span> (!parts[<span class="number">0</span>].match(<span class="regexp">/([A-Za-z]:)/</span>)) {
                dir = <span class="string">'/'</span> + dir;    
            }
            dirs.push(dir);
        }
        <span class="keyword">return</span> opts.paths.concat(dirs);
    }
};
</code></pre>