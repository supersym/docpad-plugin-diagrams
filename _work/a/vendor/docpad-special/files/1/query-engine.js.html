<h1>query-engine.js</h1>
<pre><code class="lang-js"><span class="comment">// Generated by CoffeeScript 1.4.0</span>
(<span class="keyword">function</span>() {
  <span class="keyword">var</span> Backbone, Criteria, Hash, Pill, Query, QueryCollection, queryEngine, util, _ref,
    __hasProp = {}.hasOwnProperty,
    __slice = [].slice,
    __extends = <span class="keyword">function</span>(child, parent) { <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> parent) { <span class="keyword">if</span> (__hasProp.call(parent, key)) child[key] = parent[key]; } <span class="function"><span class="keyword">function</span> <span class="title">ctor</span><span class="params">()</span> {</span> <span class="keyword">this</span>.constructor = child; } ctor.prototype = parent.prototype; child.prototype = <span class="keyword">new</span> ctor(); child.__super__ = parent.prototype; <span class="keyword">return</span> child; },
    __indexOf = [].indexOf || <span class="keyword">function</span>(item) { <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.length; i &lt; l; i++) { <span class="keyword">if</span> (i <span class="keyword">in</span> <span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>[i] === item) <span class="keyword">return</span> i; } <span class="keyword">return</span> -<span class="number">1</span>; },
    __bind = <span class="keyword">function</span>(fn, me){ <span class="keyword">return</span> <span class="keyword">function</span>(){ <span class="keyword">return</span> fn.apply(me, arguments); }; };

  <span class="keyword">try</span> {
    Backbone = (_ref = (<span class="keyword">typeof</span> module !== <span class="string">"undefined"</span> &amp;&amp; module !== <span class="literal">null</span> ? require(<span class="string">'backbone'</span>) : <span class="keyword">this</span>.Backbone)) != <span class="literal">null</span> ? _ref : <span class="literal">null</span>;
  } <span class="keyword">catch</span> (err) {
    Backbone = <span class="literal">null</span>;
  }

  util = {
    toString: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> Object.prototype.toString.call(value);
    },
    isPlainObject: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.isObject(value) &amp;&amp; value.__proto__ === Object.prototype;
    },
    isObject: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span>;
    },
    isError: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> value <span class="keyword">instanceof</span> Error;
    },
    isDate: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.toString(value) === <span class="string">'[object Date]'</span>;
    },
    isArguments: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.toString(value) === <span class="string">'[object Arguments]'</span>;
    },
    isFunction: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.toString(value) === <span class="string">'[object Function]'</span>;
    },
    isRegExp: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.toString(value) === <span class="string">'[object RegExp]'</span>;
    },
    isArray: <span class="keyword">function</span>(value) {
      <span class="keyword">if</span> (Array.isArray != <span class="literal">null</span>) {
        <span class="keyword">return</span> Array.isArray(value);
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> util.toString(value) === <span class="string">'[object Array]'</span>;
      }
    },
    isNumber: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'number'</span> || util.toString(value) === <span class="string">'[object Number]'</span>;
    },
    isString: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'string'</span> || util.toString(value) === <span class="string">'[object String]'</span>;
    },
    isBoolean: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> value === <span class="literal">true</span> || value === <span class="literal">false</span> || util.toString(value) === <span class="string">'[object Boolean]'</span>;
    },
    isNull: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> value === <span class="literal">null</span>;
    },
    isUndefined: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'undefined'</span>;
    },
    isDefined: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> <span class="keyword">typeof</span> value !== <span class="string">'undefined'</span>;
    },
    isEmpty: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> value != <span class="literal">null</span>;
    },
    isObjectEmpty: <span class="keyword">function</span>(object) {
      <span class="keyword">var</span> empty, key, value;
      empty = <span class="literal">true</span>;
      <span class="keyword">for</span> (key <span class="keyword">in</span> object) {
        <span class="keyword">if</span> (!__hasProp.call(object, key)) <span class="keyword">continue</span>;
        value = object[key];
        empty = <span class="literal">false</span>;
        <span class="keyword">break</span>;
      }
      <span class="keyword">return</span> empty;
    },
    isComparable: <span class="keyword">function</span>(value) {
      <span class="keyword">return</span> util.isNumber(value) || util.isDate(value);
    },
    isEqual: <span class="keyword">function</span>(value1, value2) {
      <span class="keyword">return</span> JSON.stringify(value1) === JSON.stringify(value2);
    },
    clone: <span class="keyword">function</span>() {
      <span class="keyword">var</span> args;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">return</span> util.shallowExtendPlainObjects.apply(util, [{}].concat(__slice.call(args)));
    },
    extend: <span class="keyword">function</span>() {
      <span class="keyword">var</span> args;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">return</span> util.shallowExtendPlainObjects.apply(util, args);
    },
    shallowExtendPlainObjects: <span class="keyword">function</span>() {
      <span class="keyword">var</span> key, obj, objs, target, value, _i, _len;
      target = arguments[<span class="number">0</span>], objs = <span class="number">2</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">1</span>) : [];
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = objs.length; _i &lt; _len; _i++) {
        obj = objs[_i];
        obj || (obj = {});
        <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {
          <span class="keyword">if</span> (!__hasProp.call(obj, key)) <span class="keyword">continue</span>;
          value = obj[key];
          target[key] = value;
        }
      }
      <span class="keyword">return</span> target;
    },
    get: <span class="keyword">function</span>(obj, key) {
      <span class="keyword">var</span> result;
      <span class="keyword">if</span> (obj.get != <span class="literal">null</span>) {
        result = obj.get(key);
      } <span class="keyword">else</span> {
        result = obj[key];
      }
      <span class="keyword">return</span> result;
    },
    safeRegex: <span class="keyword">function</span>(str) {
      <span class="keyword">if</span> (str === <span class="literal">false</span>) {
        <span class="keyword">return</span> <span class="string">'false'</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (str === <span class="literal">true</span>) {
        <span class="keyword">return</span> <span class="string">'true'</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (str === <span class="literal">null</span>) {
        <span class="keyword">return</span> <span class="string">'null'</span>;
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> (str || <span class="string">''</span>).replace(<span class="string">'(.)'</span>, <span class="string">'\\$1'</span>);
      }
    },
    createRegex: <span class="keyword">function</span>(str) {
      <span class="keyword">return</span> <span class="keyword">new</span> RegExp(str, <span class="string">'ig'</span>);
    },
    createSafeRegex: <span class="keyword">function</span>(str) {
      <span class="keyword">return</span> util.createRegex(util.safeRegex(str));
    },
    toArray: <span class="keyword">function</span>(value) {
      <span class="keyword">var</span> item, key, result, valueExists;
      result = [];
      valueExists = <span class="keyword">typeof</span> value !== <span class="string">'undefined'</span>;
      <span class="keyword">if</span> (valueExists) {
        <span class="keyword">if</span> (util.isArray(value)) {
          result = value.slice();
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isObject(value)) {
          <span class="keyword">for</span> (key <span class="keyword">in</span> value) {
            <span class="keyword">if</span> (!__hasProp.call(value, key)) <span class="keyword">continue</span>;
            item = value[key];
            result.push(item);
          }
        } <span class="keyword">else</span> {
          result.push(value);
        }
      }
      <span class="keyword">return</span> result;
    },
    toArrayGroup: <span class="keyword">function</span>(value) {
      <span class="keyword">var</span> item, key, obj, result, valueExists;
      result = [];
      valueExists = <span class="keyword">typeof</span> value !== <span class="string">'undefined'</span>;
      <span class="keyword">if</span> (valueExists) {
        <span class="keyword">if</span> (util.isArray(value)) {
          result = value.slice();
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isObject(value)) {
          <span class="keyword">for</span> (key <span class="keyword">in</span> value) {
            <span class="keyword">if</span> (!__hasProp.call(value, key)) <span class="keyword">continue</span>;
            item = value[key];
            obj = {};
            obj[key] = item;
            result.push(obj);
          }
        } <span class="keyword">else</span> {
          result.push(value);
        }
      }
      <span class="keyword">return</span> result;
    },
    generateComparator: <span class="keyword">function</span>(input) {
      <span class="keyword">var</span> generateFunction;
      generateFunction = <span class="keyword">function</span>(comparator) {
        <span class="keyword">if</span> (!comparator) {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Cannot sort without a comparator'</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isFunction(comparator)) {
          <span class="keyword">return</span> comparator;
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isArray(comparator)) {
          <span class="keyword">return</span> <span class="keyword">function</span>(a, b) {
            <span class="keyword">var</span> comparison, key, value, _i, _len;
            comparison = <span class="number">0</span>;
            <span class="keyword">for</span> (key = _i = <span class="number">0</span>, _len = comparator.length; _i &lt; _len; key = ++_i) {
              value = comparator[key];
              comparison = generateFunction(value)(a, b);
              <span class="keyword">if</span> (comparison) {
                <span class="keyword">return</span> comparison;
              }
            }
            <span class="keyword">return</span> comparison;
          };
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isObject(comparator)) {
          <span class="keyword">return</span> <span class="keyword">function</span>(a, b) {
            <span class="keyword">var</span> aValue, bValue, comparison, key, value;
            comparison = <span class="number">0</span>;
            <span class="keyword">for</span> (key <span class="keyword">in</span> comparator) {
              <span class="keyword">if</span> (!__hasProp.call(comparator, key)) <span class="keyword">continue</span>;
              value = comparator[key];
              aValue = util.get(a, key);
              bValue = util.get(b, key);
              <span class="keyword">if</span> (aValue === bValue) {
                comparison = <span class="number">0</span>;
              } <span class="keyword">else</span> <span class="keyword">if</span> (aValue &lt; bValue) {
                comparison = -<span class="number">1</span>;
              } <span class="keyword">else</span> <span class="keyword">if</span> (aValue > bValue) {
                comparison = <span class="number">1</span>;
              }
              <span class="keyword">if</span> (value === -<span class="number">1</span>) {
                comparison *= -<span class="number">1</span>;
              }
              <span class="keyword">if</span> (comparison) {
                <span class="keyword">return</span> comparison;
              }
            }
            <span class="keyword">return</span> comparison;
          };
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Unknown comparator type'</span>);
        }
      };
      <span class="keyword">return</span> generateFunction(input);
    }
  };

  Hash = (<span class="keyword">function</span>(_super) {

    __extends(Hash, _super);

    <span class="function"><span class="keyword">function</span> <span class="title">Hash</span><span class="params">(value)</span> {</span>
      <span class="keyword">var</span> item, key, _i, _len;
      value = util.toArray(value);
      <span class="keyword">for</span> (key = _i = <span class="number">0</span>, _len = value.length; _i &lt; _len; key = ++_i) {
        item = value[key];
        <span class="keyword">this</span>.push(item);
      }
    }

    Hash.prototype.hasIn = <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> value, _i, _len;
      options = util.toArray(options);
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = <span class="keyword">this</span>.length; _i &lt; _len; _i++) {
        value = <span class="keyword">this</span>[_i];
        <span class="keyword">if</span> (__indexOf.call(options, value) >= <span class="number">0</span>) {
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
      }
      <span class="keyword">return</span> <span class="literal">false</span>;
    };

    Hash.prototype.hasAll = <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> empty, pass, value, _i, _len;
      options = util.toArray(options);
      empty = <span class="literal">true</span>;
      pass = <span class="literal">true</span>;
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = <span class="keyword">this</span>.length; _i &lt; _len; _i++) {
        value = <span class="keyword">this</span>[_i];
        empty = <span class="literal">false</span>;
        <span class="keyword">if</span> (__indexOf.call(options, value) &lt; <span class="number">0</span>) {
          pass = <span class="literal">false</span>;
        }
      }
      <span class="keyword">if</span> (empty) {
        pass = <span class="literal">false</span>;
      }
      <span class="keyword">return</span> pass;
    };

    Hash.prototype.isSame = <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> pass;
      options = util.toArray(options);
      pass = <span class="keyword">this</span>.sort().join() === options.sort().join();
      <span class="keyword">return</span> pass;
    };

    <span class="keyword">return</span> Hash;

  })(Array);

  <span class="keyword">if</span> (Backbone == <span class="literal">null</span>) {
    QueryCollection = <span class="literal">null</span>;
  } <span class="keyword">else</span> {
    QueryCollection = (<span class="keyword">function</span>(_super) {

      __extends(QueryCollection, _super);

      <span class="function"><span class="keyword">function</span> <span class="title">QueryCollection</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.onParentReset = __bind(<span class="keyword">this</span>.onParentReset, <span class="keyword">this</span>);

        <span class="keyword">this</span>.onParentAdd = __bind(<span class="keyword">this</span>.onParentAdd, <span class="keyword">this</span>);

        <span class="keyword">this</span>.onParentRemove = __bind(<span class="keyword">this</span>.onParentRemove, <span class="keyword">this</span>);

        <span class="keyword">this</span>.onParentChange = __bind(<span class="keyword">this</span>.onParentChange, <span class="keyword">this</span>);

        <span class="keyword">this</span>.onChange = __bind(<span class="keyword">this</span>.onChange, <span class="keyword">this</span>);
        <span class="keyword">return</span> QueryCollection.__super__.constructor.apply(<span class="keyword">this</span>, arguments);
      }

      QueryCollection.prototype.model = Backbone.Model;

      QueryCollection.prototype.initialize = <span class="keyword">function</span>(models, options) {
        <span class="keyword">var</span> key, me, value, _ref1, _ref2, _ref3;
        me = <span class="keyword">this</span>;
        <span class="keyword">if</span> ((_ref1 = <span class="keyword">this</span>.options) == <span class="literal">null</span>) {
          <span class="keyword">this</span>.options = {};
        }
        _ref2 = Criteria.prototype;
        <span class="keyword">for</span> (key <span class="keyword">in</span> _ref2) {
          <span class="keyword">if</span> (!__hasProp.call(_ref2, key)) <span class="keyword">continue</span>;
          value = _ref2[key];
          <span class="keyword">if</span> ((_ref3 = <span class="keyword">this</span>[key]) == <span class="literal">null</span>) {
            <span class="keyword">this</span>[key] = value;
          }
        }
        <span class="keyword">if</span> (<span class="keyword">this</span>.comparator != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setComparator(<span class="keyword">this</span>.comparator);
        }
        <span class="keyword">this</span>.applyCriteriaOptions(options);
        <span class="keyword">if</span> (options != <span class="literal">null</span>) {
          <span class="keyword">if</span> (options.parentCollection != <span class="literal">null</span>) {
            <span class="keyword">this</span>.options.parentCollection = options.parentCollection;
          }
          <span class="keyword">if</span> (options.live != <span class="literal">null</span>) {
            <span class="keyword">this</span>.options.live = options.live;
          }
          <span class="keyword">this</span>.live();
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.getComparator = <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.comparator;
      };

      QueryCollection.prototype.setComparator = <span class="keyword">function</span>(comparator) {
        comparator = util.generateComparator(comparator);
        <span class="keyword">this</span>.comparator = comparator;
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.createChildCollection = <span class="keyword">function</span>(models, options) {
        <span class="keyword">var</span> collection, _ref1, _ref2;
        options || (options = {});
        options.parentCollection = <span class="keyword">this</span>;
        <span class="keyword">if</span> ((_ref1 = options.collection) == <span class="literal">null</span>) {
          options.collection = <span class="keyword">this</span>.collection || QueryCollection;
        }
        <span class="keyword">if</span> ((_ref2 = options.comparator) == <span class="literal">null</span>) {
          options.comparator = options.collection.prototype.comparator || <span class="keyword">this</span>.comparator;
        }
        collection = <span class="keyword">new</span> options.collection(models, options);
        <span class="keyword">return</span> collection;
      };

      QueryCollection.prototype.createLiveChildCollection = <span class="keyword">function</span>(models, options) {
        <span class="keyword">var</span> collection;
        options || (options = {});
        options.live = <span class="literal">true</span>;
        collection = <span class="keyword">this</span>.createChildCollection(models, options);
        <span class="keyword">return</span> collection;
      };

      QueryCollection.prototype.hasParentCollection = <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.options.parentCollection != <span class="literal">null</span>;
      };

      QueryCollection.prototype.getParentCollection = <span class="keyword">function</span>() {
        <span class="keyword">return</span> <span class="keyword">this</span>.options.parentCollection;
      };

      QueryCollection.prototype.setParentCollection = <span class="keyword">function</span>(parentCollection, skipCheck) {
        <span class="keyword">if</span> (!skipCheck &amp;&amp; <span class="keyword">this</span>.options.parentCollection === parentCollection) {
          <span class="keyword">return</span> <span class="keyword">this</span>;
        }
        <span class="keyword">this</span>.options.parentCollection = parentCollection;
        <span class="keyword">this</span>.live();
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.hasModel = <span class="keyword">function</span>(model) {
        <span class="keyword">var</span> exists;
        model || (model = {});
        <span class="keyword">if</span> ((model.id != <span class="literal">null</span>) &amp;&amp; <span class="keyword">this</span>.get(model.id)) {
          exists = <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> ((model.cid != <span class="literal">null</span>) &amp;&amp; (<span class="keyword">this</span>._byCid[model.cid] != <span class="literal">null</span>)) {
          exists = <span class="literal">true</span>;
        } <span class="keyword">else</span> {
          exists = <span class="literal">false</span>;
        }
        <span class="keyword">return</span> exists;
      };

      QueryCollection.prototype.safeRemove = <span class="keyword">function</span>(model) {
        <span class="keyword">var</span> exists;
        exists = <span class="keyword">this</span>.hasModel(model);
        <span class="keyword">if</span> (exists) {
          <span class="keyword">this</span>.remove(model);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.safeAdd = <span class="keyword">function</span>(model) {
        <span class="keyword">var</span> exists;
        exists = <span class="keyword">this</span>.hasModel(model);
        <span class="keyword">if</span> (!exists) {
          <span class="keyword">this</span>.add(model);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.sortCollection = <span class="keyword">function</span>(comparator) {
        <span class="keyword">if</span> (comparator) {
          comparator = util.generateComparator(comparator);
          <span class="keyword">this</span>.models.sort(comparator);
        } <span class="keyword">else</span> {
          comparator = <span class="keyword">this</span>.getComparator();
          <span class="keyword">if</span> (comparator) {
            <span class="keyword">this</span>.models.sort(comparator);
          } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'You need a comparator to sort'</span>);
          }
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.sortArray = <span class="keyword">function</span>(comparator) {
        <span class="keyword">var</span> arr;
        arr = <span class="keyword">this</span>.toJSON();
        <span class="keyword">if</span> (comparator) {
          comparator = util.generateComparator(comparator);
          arr.sort(comparator);
        } <span class="keyword">else</span> {
          comparator = <span class="keyword">this</span>.getComparator();
          <span class="keyword">if</span> (comparator) {
            arr.sort(comparator);
          } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'You need a comparator to sort'</span>);
          }
        }
        <span class="keyword">return</span> arr;
      };

      QueryCollection.prototype.findAll = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, collection, comparator, criteriaOptions, paging, query;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        <span class="keyword">if</span> (args.length) {
          <span class="keyword">if</span> (args.length === <span class="number">1</span> &amp;&amp; args[<span class="number">0</span>] <span class="keyword">instanceof</span> Criteria) {
            criteriaOptions = args[<span class="number">0</span>].options;
          } <span class="keyword">else</span> {
            query = args[<span class="number">0</span>], comparator = args[<span class="number">1</span>], paging = args[<span class="number">2</span>];
            criteriaOptions = {
              comparator: comparator,
              paging: paging,
              queries: {
                find: query
              }
            };
          }
        } <span class="keyword">else</span> {
          criteriaOptions = <span class="literal">null</span>;
        }
        collection = <span class="keyword">this</span>.createChildCollection([], criteriaOptions).query();
        <span class="keyword">return</span> collection;
      };

      QueryCollection.prototype.findAllLive = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, collection, comparator, criteriaOptions, paging, query;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        <span class="keyword">if</span> (args.length) {
          <span class="keyword">if</span> (args.length === <span class="number">1</span> &amp;&amp; args[<span class="number">0</span>] <span class="keyword">instanceof</span> Criteria) {
            criteriaOptions = args[<span class="number">0</span>].options;
          } <span class="keyword">else</span> {
            query = args[<span class="number">0</span>], comparator = args[<span class="number">1</span>], paging = args[<span class="number">2</span>];
            criteriaOptions = {
              comparator: comparator,
              paging: paging,
              queries: {
                find: query
              }
            };
          }
        } <span class="keyword">else</span> {
          criteriaOptions = <span class="literal">null</span>;
        }
        collection = <span class="keyword">this</span>.createLiveChildCollection([], criteriaOptions).query();
        <span class="keyword">return</span> collection;
      };

      QueryCollection.prototype.findOne = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, comparator, criteriaOptions, paging, passed, query;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        <span class="keyword">if</span> (args.length) {
          <span class="keyword">if</span> (args.length === <span class="number">1</span> &amp;&amp; args[<span class="number">0</span>] <span class="keyword">instanceof</span> Criteria) {
            criteriaOptions = args[<span class="number">0</span>].options;
          } <span class="keyword">else</span> {
            query = args[<span class="number">0</span>], comparator = args[<span class="number">1</span>], paging = args[<span class="number">2</span>];
            criteriaOptions = {
              comparator: comparator,
              paging: paging,
              queries: {
                find: query
              }
            };
          }
        } <span class="keyword">else</span> {
          criteriaOptions = <span class="literal">null</span>;
        }
        passed = <span class="keyword">this</span>.testModels(<span class="keyword">this</span>.models, criteriaOptions);
        <span class="keyword">if</span> ((passed != <span class="literal">null</span> ? passed.length : <span class="keyword">void</span> <span class="number">0</span>) !== <span class="number">0</span>) {
          <span class="keyword">return</span> passed[<span class="number">0</span>];
        } <span class="keyword">else</span> {
          <span class="keyword">return</span> <span class="literal">null</span>;
        }
      };

      QueryCollection.prototype.query = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, criteria, passed;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        <span class="keyword">if</span> (args.length === <span class="number">1</span>) {
          <span class="keyword">if</span> (args[<span class="number">0</span>] <span class="keyword">instanceof</span> Criteria) {
            criteria = args[<span class="number">0</span>].options;
          } <span class="keyword">else</span> {
            criteria = {
              paging: args[<span class="number">0</span>]
            };
          }
        }
        passed = <span class="keyword">this</span>.queryModels(criteria);
        <span class="keyword">this</span>.reset(passed);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.queryModels = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, collection, criteriaOptions, models, passed;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        criteriaOptions = <span class="keyword">this</span>.extractCriteriaOptions.apply(<span class="keyword">this</span>, args);
        collection = <span class="keyword">this</span>.getParentCollection() || <span class="keyword">this</span>;
        models = collection.models;
        passed = <span class="keyword">this</span>.testModels(models, criteriaOptions);
        <span class="keyword">return</span> passed;
      };

      QueryCollection.prototype.queryArray = <span class="keyword">function</span>() {
        <span class="keyword">var</span> args, model, passed, result, _i, _len;
        args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
        result = [];
        passed = <span class="keyword">this</span>.queryModels.apply(<span class="keyword">this</span>, args);
        <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = passed.length; _i &lt; _len; _i++) {
          model = passed[_i];
          result.push(model.toJSON());
        }
        <span class="keyword">return</span> result;
      };

      QueryCollection.prototype.live = <span class="keyword">function</span>(enabled) {
        <span class="keyword">var</span> parentCollection;
        <span class="keyword">if</span> (enabled == <span class="literal">null</span>) {
          enabled = <span class="keyword">this</span>.options.live;
        }
        <span class="keyword">this</span>.options.live = enabled;
        <span class="keyword">if</span> (enabled) {
          <span class="keyword">this</span>.on(<span class="string">'change'</span>, <span class="keyword">this</span>.onChange);
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.off(<span class="string">'change'</span>, <span class="keyword">this</span>.onChange);
        }
        parentCollection = <span class="keyword">this</span>.getParentCollection();
        <span class="keyword">if</span> (parentCollection != <span class="literal">null</span>) {
          <span class="keyword">if</span> (enabled) {
            parentCollection.on(<span class="string">'change'</span>, <span class="keyword">this</span>.onParentChange);
            parentCollection.on(<span class="string">'remove'</span>, <span class="keyword">this</span>.onParentRemove);
            parentCollection.on(<span class="string">'add'</span>, <span class="keyword">this</span>.onParentAdd);
            parentCollection.on(<span class="string">'reset'</span>, <span class="keyword">this</span>.onParentReset);
          } <span class="keyword">else</span> {
            parentCollection.off(<span class="string">'change'</span>, <span class="keyword">this</span>.onParentChange);
            parentCollection.off(<span class="string">'remove'</span>, <span class="keyword">this</span>.onParentRemove);
            parentCollection.off(<span class="string">'add'</span>, <span class="keyword">this</span>.onParentAdd);
            parentCollection.off(<span class="string">'reset'</span>, <span class="keyword">this</span>.onParentReset);
          }
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.add = <span class="keyword">function</span>(models, options) {
        <span class="keyword">var</span> model, passedModels, _i, _len;
        options = options ? util.clone(options) : {};
        models = util.isArray(models) ? models.slice() : [models];
        passedModels = [];
        <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = models.length; _i &lt; _len; _i++) {
          model = models[_i];
          model = <span class="keyword">this</span>._prepareModel(model, options);
          <span class="keyword">if</span> (model &amp;&amp; <span class="keyword">this</span>.test(model)) {
            passedModels.push(model);
          }
        }
        Backbone.Collection.prototype.add.apply(<span class="keyword">this</span>, [passedModels, options]);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.create = <span class="keyword">function</span>(model, options) {
        options = options ? util.clone(options) : {};
        model = <span class="keyword">this</span>._prepareModel(model, options);
        <span class="keyword">if</span> (model &amp;&amp; <span class="keyword">this</span>.test(model)) {
          Backbone.Collection.prototype.create.apply(<span class="keyword">this</span>, [model, options]);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.onChange = <span class="keyword">function</span>(model) {
        <span class="keyword">var</span> pass;
        pass = <span class="keyword">this</span>.test(model);
        <span class="keyword">if</span> (!pass) {
          <span class="keyword">this</span>.safeRemove(model);
        } <span class="keyword">else</span> {
          <span class="keyword">if</span> (<span class="keyword">this</span>.comparator) {
            <span class="keyword">this</span>.sortCollection();
          }
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.onParentChange = <span class="keyword">function</span>(model) {
        <span class="keyword">var</span> pass;
        pass = <span class="keyword">this</span>.test(model) &amp;&amp; <span class="keyword">this</span>.getParentCollection().hasModel(model);
        <span class="keyword">if</span> (pass) {
          <span class="keyword">this</span>.safeAdd(model);
        } <span class="keyword">else</span> {
          <span class="keyword">this</span>.safeRemove(model);
        }
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.onParentRemove = <span class="keyword">function</span>(model) {
        <span class="keyword">this</span>.safeRemove(model);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.onParentAdd = <span class="keyword">function</span>(model) {
        <span class="keyword">this</span>.safeAdd(model);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      QueryCollection.prototype.onParentReset = <span class="keyword">function</span>(model) {
        <span class="keyword">this</span>.reset(<span class="keyword">this</span>.getParentCollection().models);
        <span class="keyword">return</span> <span class="keyword">this</span>;
      };

      <span class="keyword">return</span> QueryCollection;

    })(Backbone.Collection);
  }

  Criteria = (<span class="keyword">function</span>() {

    <span class="function"><span class="keyword">function</span> <span class="title">Criteria</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> args;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">this</span>.applyCriteriaOptions = __bind(<span class="keyword">this</span>.applyCriteriaOptions, <span class="keyword">this</span>);

      <span class="keyword">this</span>.applyCriteriaOptions.apply(<span class="keyword">this</span>, args);
      <span class="keyword">this</span>;

    }

    Criteria.prototype.extractCriteriaOptions = <span class="keyword">function</span>() {
      <span class="keyword">var</span> args, comparator, criteriaOptions, paging, query;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">if</span> (args.length === <span class="number">1</span>) {
        <span class="keyword">if</span> (args[<span class="number">0</span>] <span class="keyword">instanceof</span> Criteria) {
          criteriaOptions = args[<span class="number">0</span>].options;
        } <span class="keyword">else</span> <span class="keyword">if</span> (args[<span class="number">0</span>]) {
          criteriaOptions = args[<span class="number">0</span>];
        } <span class="keyword">else</span> {
          criteriaOptions = <span class="literal">null</span>;
        }
      } <span class="keyword">else</span> <span class="keyword">if</span> (args.length > <span class="number">1</span>) {
        query = args[<span class="number">0</span>], comparator = args[<span class="number">1</span>], paging = args[<span class="number">2</span>];
        criteriaOptions = {
          queries: {
            find: query || <span class="literal">null</span>
          },
          comparator: comparator,
          paging: paging
        };
      } <span class="keyword">else</span> {
        criteriaOptions = <span class="literal">null</span>;
      }
      <span class="keyword">return</span> criteriaOptions;
    };

    Criteria.prototype.applyCriteriaOptions = <span class="keyword">function</span>() {
      <span class="keyword">var</span> args, criteriaOptions, _base, _base1, _base2, _base3, _base4, _base5, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">if</span> ((_ref1 = <span class="keyword">this</span>.options) == <span class="literal">null</span>) {
        <span class="keyword">this</span>.options = {};
      }
      <span class="keyword">if</span> ((_ref2 = (_base = <span class="keyword">this</span>.options).filters) == <span class="literal">null</span>) {
        _base.filters = {};
      }
      <span class="keyword">if</span> ((_ref3 = (_base1 = <span class="keyword">this</span>.options).queries) == <span class="literal">null</span>) {
        _base1.queries = {};
      }
      <span class="keyword">if</span> ((_ref4 = (_base2 = <span class="keyword">this</span>.options).pills) == <span class="literal">null</span>) {
        _base2.pills = {};
      }
      <span class="keyword">if</span> ((_ref5 = (_base3 = <span class="keyword">this</span>.options).paging) == <span class="literal">null</span>) {
        _base3.paging = {};
      }
      <span class="keyword">if</span> ((_ref6 = (_base4 = <span class="keyword">this</span>.options).searchString) == <span class="literal">null</span>) {
        _base4.searchString = <span class="literal">null</span>;
      }
      <span class="keyword">if</span> ((_ref7 = (_base5 = <span class="keyword">this</span>.options).comparator) == <span class="literal">null</span>) {
        _base5.comparator = <span class="literal">null</span>;
      }
      criteriaOptions = <span class="keyword">this</span>.extractCriteriaOptions.apply(<span class="keyword">this</span>, args);
      <span class="keyword">if</span> (criteriaOptions) {
        <span class="keyword">if</span> (criteriaOptions.filters != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setFilters(criteriaOptions.filters);
        }
        <span class="keyword">if</span> (criteriaOptions.queries != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setQueries(criteriaOptions.queries);
        }
        <span class="keyword">if</span> (criteriaOptions.pills != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setPills(criteriaOptions.pills);
        }
        <span class="keyword">if</span> (criteriaOptions.paging != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setPaging(criteriaOptions.paging);
        }
        <span class="keyword">if</span> (criteriaOptions.searchString != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setSearchString(criteriaOptions.searchString);
        }
        <span class="keyword">if</span> (criteriaOptions.comparator != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setComparator(criteriaOptions.comparator);
        }
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getPaging = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.paging;
    };

    Criteria.prototype.setPaging = <span class="keyword">function</span>(paging) {
      paging = util.extend(<span class="keyword">this</span>.getPaging(), paging || {});
      paging.page || (paging.page = <span class="literal">null</span>);
      paging.limit || (paging.limit = <span class="literal">null</span>);
      paging.offset || (paging.offset = <span class="literal">null</span>);
      <span class="keyword">this</span>.options.paging = paging;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getComparator = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.comparator;
    };

    Criteria.prototype.setComparator = <span class="keyword">function</span>(comparator) {
      comparator = util.generateComparator(comparator);
      <span class="keyword">this</span>.options.comparator = comparator;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getFilter = <span class="keyword">function</span>(key) {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.filters[key];
    };

    Criteria.prototype.getFilters = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.filters;
    };

    Criteria.prototype.setFilters = <span class="keyword">function</span>(filters) {
      <span class="keyword">var</span> key, value;
      filters || (filters = {});
      <span class="keyword">for</span> (key <span class="keyword">in</span> filters) {
        <span class="keyword">if</span> (!__hasProp.call(filters, key)) <span class="keyword">continue</span>;
        value = filters[key];
        <span class="keyword">this</span>.setFilter(key, value);
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.setFilter = <span class="keyword">function</span>(name, value) {
      <span class="keyword">var</span> filters;
      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'QueryCollection::setFilter was called without both arguments'</span>);
      }
      filters = <span class="keyword">this</span>.options.filters;
      <span class="keyword">if</span> (value != <span class="literal">null</span>) {
        filters[name] = value;
      } <span class="keyword">else</span> <span class="keyword">if</span> (filters[name] != <span class="literal">null</span>) {
        <span class="keyword">delete</span> filters[name];
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getQuery = <span class="keyword">function</span>(key) {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.queries[key];
    };

    Criteria.prototype.getQueries = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.queries;
    };

    Criteria.prototype.setQueries = <span class="keyword">function</span>(queries) {
      <span class="keyword">var</span> key, value;
      queries || (queries = {});
      <span class="keyword">for</span> (key <span class="keyword">in</span> queries) {
        <span class="keyword">if</span> (!__hasProp.call(queries, key)) <span class="keyword">continue</span>;
        value = queries[key];
        <span class="keyword">this</span>.setQuery(key, value);
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.setQuery = <span class="keyword">function</span>(name, value) {
      <span class="keyword">var</span> queries;
      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'QueryCollection::setQuery was called without both arguments'</span>);
      }
      queries = <span class="keyword">this</span>.options.queries;
      <span class="keyword">if</span> (value != <span class="literal">null</span>) {
        <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Query)) {
          value = <span class="keyword">new</span> Query(value);
        }
        queries[name] = value;
      } <span class="keyword">else</span> <span class="keyword">if</span> (queries[name] != <span class="literal">null</span>) {
        <span class="keyword">delete</span> queries[name];
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getPill = <span class="keyword">function</span>(key) {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.pills[key];
    };

    Criteria.prototype.getPills = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.pills;
    };

    Criteria.prototype.setPills = <span class="keyword">function</span>(pills) {
      <span class="keyword">var</span> key, value;
      pills || (pills = {});
      <span class="keyword">for</span> (key <span class="keyword">in</span> pills) {
        <span class="keyword">if</span> (!__hasProp.call(pills, key)) <span class="keyword">continue</span>;
        value = pills[key];
        <span class="keyword">this</span>.setPill(key, value);
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.setPill = <span class="keyword">function</span>(name, value) {
      <span class="keyword">var</span> pills, searchString;
      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'QueryCollection::setPill was called without both arguments'</span>);
      }
      pills = <span class="keyword">this</span>.getPills();
      searchString = <span class="keyword">this</span>.getSearchString();
      <span class="keyword">if</span> (value != <span class="literal">null</span>) {
        <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Pill)) {
          value = <span class="keyword">new</span> Pill(value);
        }
        <span class="keyword">if</span> (searchString) {
          value.setSearchString(searchString);
        }
        pills[name] = value;
      } <span class="keyword">else</span> <span class="keyword">if</span> (pills[name] != <span class="literal">null</span>) {
        <span class="keyword">delete</span> pills[name];
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.getCleanedSearchString = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.cleanedSearchString;
    };

    Criteria.prototype.getSearchString = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>.options.searchString;
    };

    Criteria.prototype.setSearchString = <span class="keyword">function</span>(searchString) {
      <span class="keyword">var</span> cleanedSearchString, pill, pillName, pills;
      pills = <span class="keyword">this</span>.options.pills;
      cleanedSearchString = searchString;
      <span class="keyword">for</span> (pillName <span class="keyword">in</span> pills) {
        <span class="keyword">if</span> (!__hasProp.call(pills, pillName)) <span class="keyword">continue</span>;
        pill = pills[pillName];
        cleanedSearchString = pill.setSearchString(cleanedSearchString);
      }
      <span class="keyword">this</span>.options.searchString = searchString;
      <span class="keyword">this</span>.options.cleanedSearchString = cleanedSearchString;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Criteria.prototype.test = <span class="keyword">function</span>() {
      <span class="keyword">var</span> args;
      args = <span class="number">1</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">0</span>) : [];
      <span class="keyword">return</span> <span class="keyword">this</span>.testModel.apply(<span class="keyword">this</span>, args);
    };

    Criteria.prototype.testModel = <span class="keyword">function</span>(model, criteriaOptions) {
      <span class="keyword">var</span> passed;
      passed = <span class="keyword">this</span>.testQueries(model, criteriaOptions != <span class="literal">null</span> ? criteriaOptions.queries : <span class="keyword">void</span> <span class="number">0</span>) &amp;&amp; <span class="keyword">this</span>.testFilters(model, criteriaOptions != <span class="literal">null</span> ? criteriaOptions.filters : <span class="keyword">void</span> <span class="number">0</span>) &amp;&amp; <span class="keyword">this</span>.testPills(model, criteriaOptions != <span class="literal">null</span> ? criteriaOptions.pills : <span class="keyword">void</span> <span class="number">0</span>);
      <span class="keyword">return</span> passed;
    };

    Criteria.prototype.testModels = <span class="keyword">function</span>(models, criteriaOptions) {
      <span class="keyword">var</span> comparator, finish, me, model, paging, pass, passed, start, _i, _len, _ref1;
      me = <span class="keyword">this</span>;
      passed = [];
      paging = (_ref1 = criteriaOptions != <span class="literal">null</span> ? criteriaOptions.paging : <span class="keyword">void</span> <span class="number">0</span>) != <span class="literal">null</span> ? _ref1 : <span class="keyword">this</span>.getPaging();
      comparator = (criteriaOptions != <span class="literal">null</span> ? criteriaOptions.comparator : <span class="keyword">void</span> <span class="number">0</span>) != <span class="literal">null</span> ? util.generateComparator(criteriaOptions != <span class="literal">null</span> ? criteriaOptions.comparator : <span class="keyword">void</span> <span class="number">0</span>) : <span class="keyword">this</span>.getComparator();
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = models.length; _i &lt; _len; _i++) {
        model = models[_i];
        pass = me.testModel(model, criteriaOptions);
        <span class="keyword">if</span> (pass) {
          passed.push(model);
        }
      }
      <span class="keyword">if</span> (comparator) {
        passed.sort(comparator);
      }
      <span class="keyword">if</span> (paging) {
        start = paging.offset || <span class="number">0</span>;
        <span class="keyword">if</span> ((paging.limit != <span class="literal">null</span>) &amp;&amp; paging.limit > <span class="number">0</span>) {
          start = start + paging.limit * ((paging.page || <span class="number">1</span>) - <span class="number">1</span>);
          finish = start + paging.limit;
          passed = passed.slice(start, finish);
        } <span class="keyword">else</span> {
          passed = passed.slice(start);
        }
      }
      <span class="keyword">return</span> passed;
    };

    Criteria.prototype.testQueries = <span class="keyword">function</span>(model, queries) {
      <span class="keyword">var</span> passed, query, queryName;
      passed = <span class="literal">true</span>;
      <span class="keyword">if</span> (queries == <span class="literal">null</span>) {
        queries = <span class="keyword">this</span>.getQueries();
      }
      <span class="keyword">for</span> (queryName <span class="keyword">in</span> queries) {
        <span class="keyword">if</span> (!__hasProp.call(queries, queryName)) <span class="keyword">continue</span>;
        query = queries[queryName];
        <span class="keyword">if</span> (!(query <span class="keyword">instanceof</span> Query)) {
          query = <span class="keyword">new</span> Query(query);
          queries[queryName] = query;
        }
        <span class="keyword">if</span> (query.test(model) === <span class="literal">false</span>) {
          passed = <span class="literal">false</span>;
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      }
      <span class="keyword">return</span> passed;
    };

    Criteria.prototype.testFilters = <span class="keyword">function</span>(model, filters) {
      <span class="keyword">var</span> cleanedSearchString, filter, filterName, passed;
      passed = <span class="literal">true</span>;
      cleanedSearchString = <span class="keyword">this</span>.getCleanedSearchString();
      <span class="keyword">if</span> (filters == <span class="literal">null</span>) {
        filters = <span class="keyword">this</span>.getFilters();
      }
      <span class="keyword">for</span> (filterName <span class="keyword">in</span> filters) {
        <span class="keyword">if</span> (!__hasProp.call(filters, filterName)) <span class="keyword">continue</span>;
        filter = filters[filterName];
        <span class="keyword">if</span> (filter(model, cleanedSearchString) === <span class="literal">false</span>) {
          passed = <span class="literal">false</span>;
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      }
      <span class="keyword">return</span> passed;
    };

    Criteria.prototype.testPills = <span class="keyword">function</span>(model, pills) {
      <span class="keyword">var</span> passed, pill, pillName, searchString;
      passed = <span class="literal">true</span>;
      searchString = <span class="keyword">this</span>.getSearchString();
      <span class="keyword">if</span> (pills == <span class="literal">null</span>) {
        pills = <span class="keyword">this</span>.getPills();
      }
      <span class="keyword">if</span> (searchString != <span class="literal">null</span>) {
        <span class="keyword">for</span> (pillName <span class="keyword">in</span> pills) {
          <span class="keyword">if</span> (!__hasProp.call(pills, pillName)) <span class="keyword">continue</span>;
          pill = pills[pillName];
          <span class="keyword">if</span> (!(pill <span class="keyword">instanceof</span> Pill)) {
            pill = <span class="keyword">new</span> Pill(query);
            pill.setSearchString(searchString);
            pills[pillName] = pill;
          }
          <span class="keyword">if</span> (pill.test(model) === <span class="literal">false</span>) {
            passed = <span class="literal">false</span>;
            <span class="keyword">return</span> <span class="literal">false</span>;
          }
        }
      }
      <span class="keyword">return</span> passed;
    };

    <span class="keyword">return</span> Criteria;

  })();

  Pill = (<span class="keyword">function</span>() {

    Pill.prototype.callback = <span class="literal">null</span>;

    Pill.prototype.regex = <span class="literal">null</span>;

    Pill.prototype.prefixes = <span class="literal">null</span>;

    Pill.prototype.searchString = <span class="literal">null</span>;

    Pill.prototype.values = <span class="literal">null</span>;

    Pill.prototype.logicalOperator = <span class="string">'OR'</span>;

    <span class="function"><span class="keyword">function</span> <span class="title">Pill</span><span class="params">(pill)</span> {</span>
      <span class="keyword">var</span> prefix, regexString, safePrefixes, safePrefixesStr, _i, _len, _ref1;
      pill || (pill = {});
      <span class="keyword">this</span>.callback = pill.callback;
      <span class="keyword">this</span>.prefixes = pill.prefixes;
      <span class="keyword">if</span> (pill.logicalOperator != <span class="literal">null</span>) {
        <span class="keyword">this</span>.logicalOperator = pill.logicalOperator;
      }
      safePrefixes = [];
      _ref1 = <span class="keyword">this</span>.prefixes;
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
        prefix = _ref1[_i];
        safePrefixes.push(util.safeRegex(prefix));
      }
      safePrefixesStr = safePrefixes.join(<span class="string">'|'</span>);
      regexString = <span class="string">"("</span> + safePrefixesStr + <span class="string">")\\s*('[^']+'|\\\"[^\\\"]+\\\"|[^'\\\"\\s]\\S*)"</span>;
      <span class="keyword">this</span>.regex = util.createRegex(regexString);
      <span class="keyword">this</span>;

    }

    Pill.prototype.setSearchString = <span class="keyword">function</span>(searchString) {
      <span class="keyword">var</span> cleanedSearchString, match, value, values;
      cleanedSearchString = searchString;
      values = [];
      <span class="keyword">while</span> (match = <span class="keyword">this</span>.regex.exec(searchString)) {
        value = match[<span class="number">2</span>].trim().replace(<span class="regexp">/(^['"]\s*|\s*['"]$)/g</span>, <span class="string">''</span>);
        <span class="keyword">switch</span> (value) {
          <span class="keyword">case</span> <span class="string">'true'</span>:
          <span class="keyword">case</span> <span class="string">'TRUE'</span>:
            value = <span class="literal">true</span>;
            <span class="keyword">break</span>;
          <span class="keyword">case</span> <span class="string">'false'</span>:
          <span class="keyword">case</span> <span class="string">'FALSE'</span>:
            value = <span class="literal">false</span>;
            <span class="keyword">break</span>;
          <span class="keyword">case</span> <span class="string">'null'</span>:
          <span class="keyword">case</span> <span class="string">'NULL'</span>:
            value = <span class="literal">null</span>;
        }
        values.push(value);
        cleanedSearchString = cleanedSearchString.replace(match[<span class="number">0</span>], <span class="string">''</span>).trim();
      }
      <span class="keyword">this</span>.searchString = searchString;
      <span class="keyword">this</span>.values = values;
      <span class="keyword">return</span> cleanedSearchString;
    };

    Pill.prototype.test = <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> pass, value, _i, _j, _len, _len1, _ref1, _ref2, _ref3;
      <span class="keyword">if</span> ((_ref1 = <span class="keyword">this</span>.values) != <span class="literal">null</span> ? _ref1.length : <span class="keyword">void</span> <span class="number">0</span>) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.logicalOperator === <span class="string">'OR'</span>) {
          pass = <span class="literal">false</span>;
          _ref2 = <span class="keyword">this</span>.values;
          <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref2.length; _i &lt; _len; _i++) {
            value = _ref2[_i];
            pass = <span class="keyword">this</span>.callback(model, value);
            <span class="keyword">if</span> (pass) {
              <span class="keyword">break</span>;
            }
          }
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.logicalOperator === <span class="string">'AND'</span>) {
          pass = <span class="literal">false</span>;
          _ref3 = <span class="keyword">this</span>.values;
          <span class="keyword">for</span> (_j = <span class="number">0</span>, _len1 = _ref3.length; _j &lt; _len1; _j++) {
            value = _ref3[_j];
            pass = <span class="keyword">this</span>.callback(model, value);
            <span class="keyword">if</span> (!pass) {
              <span class="keyword">break</span>;
            }
          }
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Unkown logical operator type'</span>);
        }
      } <span class="keyword">else</span> {
        pass = <span class="literal">null</span>;
      }
      <span class="keyword">return</span> pass;
    };

    <span class="keyword">return</span> Pill;

  })();

  Query = (<span class="keyword">function</span>() {

    Query.prototype.source = <span class="literal">null</span>;

    Query.prototype.compiledSelectors = <span class="literal">null</span>;

    Query.prototype.selectors = {
      <span class="string">'$or'</span>: {
        compile: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> queries, query, queryGroup, querySource, _i, _len;
          queries = [];
          queryGroup = util.toArrayGroup(opts.selectorValue);
          <span class="keyword">if</span> (!queryGroup.length) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Query called with an empty "</span> + selectorName + <span class="string">" statement"</span>);
          }
          <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = queryGroup.length; _i &lt; _len; _i++) {
            querySource = queryGroup[_i];
            query = <span class="keyword">new</span> Query(querySource);
            queries.push(query);
          }
          <span class="keyword">return</span> {
            queries: queries
          };
        },
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> query, _i, _len, _ref1;
          _ref1 = opts.queries;
          <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
            query = _ref1[_i];
            <span class="keyword">if</span> (query.test(opts.model)) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$nor'</span>: {
        compile: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$or'</span>, opts);
        },
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> !opts.selector(<span class="string">'$or'</span>, opts);
        }
      },
      <span class="string">'$and'</span>: {
        compile: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$or'</span>, opts);
        },
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> query, _i, _len, _ref1;
          _ref1 = opts.queries;
          <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
            query = _ref1[_i];
            <span class="keyword">if</span> (query.test(opts.model) === <span class="literal">false</span>) {
              <span class="keyword">return</span> <span class="literal">false</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
      },
      <span class="string">'$not'</span>: {
        compile: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$and'</span>, opts);
        },
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> !opts.selector(<span class="string">'$and'</span>, opts);
        }
      },
      <span class="string">'string'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.modelValueExists &amp;&amp; opts.modelValue === opts.selectorValue;
        }
      },
      <span class="string">'number'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'string'</span>, opts);
        }
      },
      <span class="string">'boolean'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'string'</span>, opts);
        }
      },
      <span class="string">'array'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.modelValueExists &amp;&amp; (<span class="keyword">new</span> Hash(opts.modelValue)).isSame(opts.selectorValue);
        }
      },
      <span class="string">'date'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.modelValueExists &amp;&amp; opts.modelValue.toString() === opts.selectorValue.toString();
        }
      },
      <span class="string">'regexp'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.modelValueExists &amp;&amp; opts.selectorValue.test(opts.modelValue);
        }
      },
      <span class="string">'null'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.modelValue === opts.selectorValue;
        }
      },
      <span class="string">'$beginsWith'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> beginsWithParts, beginsWithValue, _i, _len;
          <span class="keyword">if</span> (opts.selectorValue &amp;&amp; opts.modelValueExists &amp;&amp; util.isString(opts.modelValue)) {
            beginsWithParts = util.toArray(opts.selectorValue);
            <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = beginsWithParts.length; _i &lt; _len; _i++) {
              beginsWithValue = beginsWithParts[_i];
              <span class="keyword">if</span> (opts.modelValue.substr(<span class="number">0</span>, beginsWithValue.length) === beginsWithValue) {
                <span class="keyword">return</span> <span class="literal">true</span>;
                <span class="keyword">break</span>;
              }
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$startsWith'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$beginsWith'</span>, opts);
        }
      },
      <span class="string">'$endsWith'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> endsWithParts, endsWithValue, _i, _len;
          <span class="keyword">if</span> (opts.selectorValue &amp;&amp; opts.modelValueExists &amp;&amp; util.isString(opts.modelValue)) {
            endsWithParts = util.toArray(opts.selectorValue);
            <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = endsWithParts.length; _i &lt; _len; _i++) {
              endsWithValue = endsWithParts[_i];
              <span class="keyword">if</span> (opts.modelValue.substr(endsWithValue.length * -<span class="number">1</span>) === endsWithValue) {
                <span class="keyword">return</span> <span class="literal">true</span>;
                <span class="keyword">break</span>;
              }
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$finishesWith'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$endsWith'</span>, opts);
        }
      },
      <span class="string">'$all'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; opts.modelValueExists) {
            <span class="keyword">if</span> ((<span class="keyword">new</span> Hash(opts.modelValue)).hasAll(opts.selectorValue)) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$in'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; opts.modelValueExists) {
            <span class="keyword">if</span> ((<span class="keyword">new</span> Hash(opts.modelValue)).hasIn(opts.selectorValue) || (<span class="keyword">new</span> Hash(opts.selectorValue)).hasIn(opts.modelValue)) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$nin'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; opts.modelValueExists) {
            <span class="keyword">if</span> ((<span class="keyword">new</span> Hash(opts.modelValue)).hasIn(opts.selectorValue) === <span class="literal">false</span> &amp;&amp; (<span class="keyword">new</span> Hash(opts.selectorValue)).hasIn(opts.modelValue) === <span class="literal">false</span>) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$has'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (opts.modelValueExists) {
            <span class="keyword">if</span> ((<span class="keyword">new</span> Hash(opts.modelValue)).hasIn(opts.selectorValue)) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$hasAll'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (opts.modelValueExists) {
            <span class="keyword">if</span> ((<span class="keyword">new</span> Hash(opts.modelValue)).hasIn(opts.selectorValue)) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$size'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (opts.modelValue.length != <span class="literal">null</span>) {
            <span class="keyword">if</span> (opts.modelValue.length === opts.selectorValue) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$length'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$size'</span>, opts);
        }
      },
      <span class="string">'$type'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.modelValue === opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$like'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (util.isString(opts.modelValue) &amp;&amp; opts.modelValue.toLowerCase().indexOf(opts.selectorValue.toLowerCase()) !== -<span class="number">1</span>) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$likeSensitive'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (util.isString(opts.modelValue) &amp;&amp; opts.modelValue.indexOf(opts.selectorValue) !== -<span class="number">1</span>) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$exists'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (opts.selectorValue === opts.modelValueExists) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$mod'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">var</span> $mod;
          <span class="keyword">if</span> (opts.modelValueExists) {
            $mod = opts.selectorValue;
            <span class="keyword">if</span> (!util.isArray($mod)) {
              $mod = [$mod];
            }
            <span class="keyword">if</span> ($mod.length === <span class="number">1</span>) {
              $mod.push(<span class="number">0</span>);
            }
            <span class="keyword">if</span> ((opts.modelValue % $mod[<span class="number">0</span>]) === $mod[<span class="number">1</span>]) {
              <span class="keyword">return</span> <span class="literal">true</span>;
            }
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$eq'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (util.isEqual(opts.modelValue, opts.selectorValue)) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$equal'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">return</span> opts.selector(<span class="string">'$eq'</span>, opts);
        }
      },
      <span class="string">'$ne'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> (opts.modelValue !== opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$lt'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.modelValue &lt; opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$gt'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.modelValue > opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$bt'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.selectorValue[<span class="number">0</span>] &lt; opts.modelValue &amp;&amp; opts.modelValue &lt; opts.selectorValue[<span class="number">1</span>]) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$lte'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.modelValue &lt;= opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$gte'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.modelValue >= opts.selectorValue) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      },
      <span class="string">'$bte'</span>: {
        test: <span class="keyword">function</span>(opts) {
          <span class="keyword">if</span> ((opts.selectorValue != <span class="literal">null</span>) &amp;&amp; util.isComparable(opts.modelValue) &amp;&amp; opts.selectorValue[<span class="number">0</span>] &lt;= opts.modelValue &amp;&amp; opts.modelValue &lt;= opts.selectorValue[<span class="number">1</span>]) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
      }
    };

    <span class="function"><span class="keyword">function</span> <span class="title">Query</span><span class="params">(source)</span> {</span>
      <span class="keyword">if</span> (source == <span class="literal">null</span>) {
        source = {};
      }
      <span class="keyword">this</span>.source = source;
      <span class="keyword">this</span>.compileQuery();
    }

    Query.prototype.compileSelector = <span class="keyword">function</span>(selectorName, selectorOpts) {
      <span class="keyword">var</span> compileOpts, compiledSelector, key, opts, query, selector, selectors, value;
      <span class="keyword">if</span> (selectorOpts == <span class="literal">null</span>) {
        selectorOpts = {};
      }
      query = <span class="keyword">this</span>;
      selectors = <span class="keyword">this</span>.selectors;
      opts = {
        selectorName: selectorName
      };
      selector = selectors[selectorName];
      <span class="keyword">if</span> (!selector) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Couldn't find the selector "</span> + selectorName);
      }
      <span class="keyword">for</span> (key <span class="keyword">in</span> selectorOpts) {
        <span class="keyword">if</span> (!__hasProp.call(selectorOpts, key)) <span class="keyword">continue</span>;
        value = selectorOpts[key];
        opts[key] = value;
      }
      <span class="keyword">if</span> (selector.compile != <span class="literal">null</span>) {
        opts.selector = <span class="keyword">function</span>(selectorName, opts) {
          <span class="keyword">return</span> selectors[selectorName].compile(opts);
        };
        compileOpts = selector.compile(opts);
        <span class="keyword">for</span> (key <span class="keyword">in</span> compileOpts) {
          <span class="keyword">if</span> (!__hasProp.call(compileOpts, key)) <span class="keyword">continue</span>;
          value = compileOpts[key];
          opts[key] = value;
        }
      }
      opts.selector = <span class="keyword">function</span>(selectorName, opts) {
        <span class="keyword">return</span> selectors[selectorName].test(opts);
      };
      compiledSelector = {
        opts: opts,
        test: selector.test
      };
      <span class="keyword">return</span> compiledSelector;
    };

    Query.prototype.testCompiledSelector = <span class="keyword">function</span>(compiledSelector, model) {
      <span class="keyword">var</span> match, opts, test;
      opts = compiledSelector.opts;
      test = compiledSelector.test;
      opts.model = model;
      opts.modelValue = util.get(opts.model, opts.fieldName);
      opts.modelId = util.get(opts.model, <span class="string">'id'</span>);
      opts.modelValueExists = <span class="keyword">typeof</span> opts.modelValue !== <span class="string">'undefined'</span>;
      <span class="keyword">if</span> (!opts.modelValueExists) {
        opts.modelValue = <span class="literal">false</span>;
      }
      match = test(opts);
      <span class="keyword">return</span> match;
    };

    Query.prototype.compileQuery = <span class="keyword">function</span>() {
      <span class="keyword">var</span> advancedSelectorName, advancedSelectorValue, compiledSelector, compiledSelectors, fieldName, query, selectorValue, _ref1;
      query = <span class="keyword">this</span>;
      compiledSelectors = [];
      _ref1 = <span class="keyword">this</span>.source;
      <span class="keyword">for</span> (fieldName <span class="keyword">in</span> _ref1) {
        <span class="keyword">if</span> (!__hasProp.call(_ref1, fieldName)) <span class="keyword">continue</span>;
        selectorValue = _ref1[fieldName];
        <span class="keyword">if</span> (fieldName === <span class="string">'$or'</span> || fieldName === <span class="string">'$nor'</span> || fieldName === <span class="string">'$and'</span> || fieldName === <span class="string">'$not'</span>) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(fieldName, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isString(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'string'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isNumber(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'number'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isBoolean(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'boolean'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isArray(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'array'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isDate(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'date'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isRegExp(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'regexp'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isNull(selectorValue)) {
          compiledSelector = <span class="keyword">this</span>.compileSelector(<span class="string">'null'</span>, {
            fieldName: fieldName,
            selectorValue: selectorValue
          });
          compiledSelectors.push(compiledSelector);
        } <span class="keyword">else</span> <span class="keyword">if</span> (util.isObject(selectorValue)) {
          <span class="keyword">for</span> (advancedSelectorName <span class="keyword">in</span> selectorValue) {
            <span class="keyword">if</span> (!__hasProp.call(selectorValue, advancedSelectorName)) <span class="keyword">continue</span>;
            advancedSelectorValue = selectorValue[advancedSelectorName];
            compiledSelector = <span class="keyword">this</span>.compileSelector(advancedSelectorName, {
              fieldName: fieldName,
              selectorValue: advancedSelectorValue
            });
            compiledSelectors.push(compiledSelector);
          }
        }
      }
      <span class="keyword">this</span>.compiledSelectors = compiledSelectors;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    };

    Query.prototype.test = <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> compiledSelector, match, _i, _len, _ref1;
      match = <span class="literal">true</span>;
      _ref1 = <span class="keyword">this</span>.compiledSelectors;
      <span class="keyword">for</span> (_i = <span class="number">0</span>, _len = _ref1.length; _i &lt; _len; _i++) {
        compiledSelector = _ref1[_i];
        match = <span class="keyword">this</span>.testCompiledSelector(compiledSelector, model);
        <span class="keyword">if</span> (match === <span class="literal">false</span>) {
          <span class="keyword">break</span>;
        }
      }
      <span class="keyword">return</span> match;
    };

    <span class="keyword">return</span> Query;

  })();

  queryEngine = {
    safeRegex: util.safeRegex,
    createRegex: util.createRegex,
    createSafeRegex: util.createSafeRegex,
    generateComparator: util.generateComparator,
    toArray: util.toArray,
    util: util,
    Backbone: Backbone,
    Hash: Hash,
    QueryCollection: QueryCollection,
    Criteria: Criteria,
    Query: Query,
    Pill: Pill,
    setQuerySelector: <span class="keyword">function</span>(selectorHandle, selectorObject) {
      <span class="keyword">if</span> (selectorObject != <span class="literal">null</span>) {
        Query.prototype.selectors[selectorHandle] = selectorObject;
      } <span class="keyword">else</span> {
        <span class="keyword">delete</span> Query.prototype.selectors[selectorHandle];
      }
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },
    testModels: <span class="keyword">function</span>() {
      <span class="keyword">var</span> args, criteria, models, result;
      models = arguments[<span class="number">0</span>], args = <span class="number">2</span> &lt;= arguments.length ? __slice.call(arguments, <span class="number">1</span>) : [];
      models = util.toArray(models);
      criteria = (<span class="keyword">function</span>(func, args, ctor) {
        ctor.prototype = func.prototype;
        <span class="keyword">var</span> child = <span class="keyword">new</span> ctor, result = func.apply(child, args);
        <span class="keyword">return</span> Object(result) === result ? result : child;
      })(Criteria, args, <span class="keyword">function</span>(){});
      result = criteria.testModels(models);
      <span class="keyword">return</span> result;
    },
    createCollection: <span class="keyword">function</span>(models, options) {
      <span class="keyword">var</span> collection;
      models = util.toArray(models);
      collection = <span class="keyword">new</span> QueryCollection(models, options);
      <span class="keyword">return</span> collection;
    },
    createLiveCollection: <span class="keyword">function</span>(models, options) {
      <span class="keyword">var</span> collection;
      models = util.toArray(models);
      collection = <span class="keyword">new</span> QueryCollection(models, options).live(<span class="literal">true</span>);
      <span class="keyword">return</span> collection;
    }
  };

  <span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">"undefined"</span> &amp;&amp; module !== <span class="literal">null</span>) {
    module.exports = queryEngine;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.queryEngine = queryEngine;
  }

}).call(<span class="keyword">this</span>);
</code></pre>